<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TikTok Integration UI — Token Flow</title>
    <style>
      :root {
        --bg: #f6f8fb;
        --card: #ffffff;
        --muted: #6b7280;
        --accent: #25a39a;
        --danger: #ef4444;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: Inter, system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial;
      }
      body {
        background: linear-gradient(180deg, #f8fbff 0%, var(--bg) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .container {
        width: 980px;
        max-width: 96%;
        background: var(--card);
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(15, 23, 42, 0.08);
        padding: 24px;
      }
      header {
        display: flex;
        gap: 16px;
        align-items: center;
      }
      .logo {
        width: 56px;
        height: 56px;
        border-radius: 10px;
        background: linear-gradient(135deg, #25a39a, #0ea5a3);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
      }
      h1 {
        margin: 0;
        font-size: 20px;
      }
      p.lead {
        margin: 4px 0 12px;
        color: var(--muted);
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 18px;
      }
      .card {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.9),
          var(--card)
        );
        padding: 14px;
        border-radius: 10px;
        border: 1px solid rgba(15, 23, 42, 0.03);
      }
      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      input[type="text"],
      input[type="datetime-local"],
      select,
      textarea {
        width: 100%;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid #e6e9ef;
        font-size: 14px;
      }
      input[type="file"] {
        font-size: 13px;
      }
      .row {
        display: flex;
        gap: 10px;
      }
      button {
        background: var(--accent);
        color: #fff;
        padding: 10px 14px;
        border-radius: 8px;
        border: 0;
        font-weight: 600;
        cursor: pointer;
      }
      button.ghost {
        background: transparent;
        color: var(--accent);
        border: 1px solid rgba(37, 163, 154, 0.12);
      }
      .small {
        font-size: 13px;
        color: var(--muted);
      }
      .status {
        padding: 12px;
        border-radius: 8px;
        background: #f3f7f9;
        border: 1px dashed rgba(15, 23, 42, 0.04);
        min-height: 72px;
      }
      pre {
        background: #0b1220;
        color: #e6eef6;
        padding: 12px;
        border-radius: 8px;
        overflow: auto;
        font-size: 12px;
      }
      footer {
        margin-top: 14px;
        text-align: center;
        color: var(--muted);
        font-size: 13px;
      }
      .hint {
        font-size: 12px;
        color: #7c8796;
      }
      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container" role="main">
      <header>
        <div class="logo">TI</div>
        <div>
          <h1>TikTok Integration — Token Flow</h1>
          <p class="lead">
            This page helps obtain an authorization code and exchange it for a
            token using a server-side exchange endpoint (required because the
            client_secret must remain secret).
          </p>
        </div>
      </header>

      <div class="grid" style="margin-top: 14px">
        <div class="card">
          <h3 style="margin-top: 0">Authentication</h3>
          <p class="small">
            Use this to open TikTok's OAuth dialog and then exchange the
            returned code via your server endpoint.
          </p>

          <div style="margin-top: 10px">
            <label>Client key (app client_key)</label>
            <input
              type="text"
              id="clientKey"
              placeholder="Enter client_key here"
              value=""
            />
          </div>

          <div style="margin-top: 10px">
            <label>Redirect URI (must be registered in your app)</label>
            <input
              type="text"
              id="redirectUri"
              placeholder="https://your-host/path"
              value=""
            />
            <div class="small hint">
              By default this page will use the current page URL. If you host on
              GitHub Pages, set the redirect to the page URL.
            </div>
          </div>

          <div style="margin-top: 10px">
            <label>Server token-exchange endpoint</label>
            <input
              type="text"
              id="exchangeEndpoint"
              placeholder="http://localhost:8000/exchange_code.php"
              value="http://localhost:8000/exchange_code.php"
            />
            <div class="small hint">
              This server endpoint must accept a POST body {code: '...'} and
              return the token JSON. Do not put client_secret in browser code.
            </div>
          </div>

          <div style="margin-top: 12px" class="row">
            <button id="btnOpenAuth">Open TikTok Login</button>
            <button id="btnExchange" class="ghost" style="display: none">
              Exchange code for token
            </button>
          </div>

          <div style="margin-top: 12px" class="status" id="authStatus">
            <div class="small">Auth status</div>
            <div id="authText" style="margin-top: 8px; color: var(--muted)">
              Idle
            </div>
          </div>

          <div style="margin-top: 12px">
            <label>Last token response</label>
            <pre id="tokenResponse">// token response will appear here</pre>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-top: 0">Quick helpers</h3>
          <p class="small">Use these tools while testing locally.</p>

          <div style="margin-top: 10px">
            <label>Saved state (for CSRF)</label>
            <input type="text" id="savedState" readonly />
          </div>

          <div style="margin-top: 10px">
            <label>Last OAuth URL</label>
            <input type="text" id="lastAuthUrl" readonly />
          </div>

          <div style="margin-top: 10px" class="small hint">
            When the page is redirected back from TikTok, it will contain
            <code>?code=...</code>. After that, click
            <em>Exchange code for token</em> or let the page auto-exchange if
            detected.
          </div>
        </div>
      </div>

      <footer>
        <div class="small">
          Important: keep your <code>client_secret</code> on the server. The
          exchange must be done server-side.
        </div>
      </footer>
    </div>

    <script>
      // helpers
      function randState() {
        return "tk_" + Math.random().toString(36).slice(2, 12);
      }
      function qs(name) {
        return new URLSearchParams(window.location.search).get(name);
      }

      // elements
      const btnOpen = document.getElementById("btnOpenAuth");
      const btnExchange = document.getElementById("btnExchange");
      const authText = document.getElementById("authText");
      const clientKeyInput = document.getElementById("clientKey");
      const redirectInput = document.getElementById("redirectUri");
      const exchangeInput = document.getElementById("exchangeEndpoint");
      const savedStateInput = document.getElementById("savedState");
      const lastAuthUrlInput = document.getElementById("lastAuthUrl");
      const tokenResponsePre = document.getElementById("tokenResponse");

      // if redirectUri not set, default to current page origin+path
      if (!redirectInput.value) {
        redirectInput.value = window.location.origin + window.location.pathname;
      }

      // Build auth URL (TikTok web auth endpoint). Note: you can change the endpoint depending on sandbox vs production.
      function buildAuthUrl() {
        const clientKey = clientKeyInput.value.trim();
        if (!clientKey) return "";
        const redirect = encodeURIComponent(redirectInput.value.trim());
        const scope = encodeURIComponent("user.info.profile user.info.stats");
        const state = randState();
        // save state for CSRF check
        localStorage.setItem("tiktok_oauth_state", state);
        savedStateInput.value = state;

        // use the general TikTok auth endpoint for web apps
        const base = "https://www.tiktok.com/v2/auth/authorize/";
        const params = `client_key=${clientKey}&response_type=code&redirect_uri=${redirect}&scope=${scope}&state=${state}`;
        const url = base + "?" + params + "&code_challenge_method=S256";

        // Store the last auth url locally
        localStorage.setItem("tiktok_last_auth_url", url);
        lastAuthUrlInput.value = url;
        return { url, state };
      }

      btnOpen.addEventListener("click", () => {
        const auth = buildAuthUrl();
        if (!auth) {
          alert("Please enter your app client_key first.");
          return;
        }
        // Redirect the user to the auth URL
        window.open(auth.url, "_blank");
        authText.textContent =
          "Opened TikTok login. After authorize, the page will redirect back with ?code=";
      });

      // detect code on page load
      const returnedCode = qs("code");
      const returnedState = qs("state");
      if (returnedCode) {
        authText.textContent = "Authorization code detected in URL.";
        btnExchange.style.display = "inline-block";

        // verify state
        const stored = localStorage.getItem("tiktok_oauth_state");
        savedStateInput.value = stored || "";
        if (!stored || stored !== returnedState) {
          authText.textContent =
            "WARNING: state mismatch (possible CSRF). Stored state: " +
            stored +
            " returned: " +
            returnedState;
        } else {
          authText.textContent =
            "State verified. Ready to exchange code for token.";
          // auto-exchange
          exchangeCode(returnedCode);
        }
      }

      async function exchangeCode(code) {
        const endpoint = exchangeInput.value.trim();
        if (!endpoint) {
          alert("Please set your exchange endpoint.");
          return;
        }

        authText.textContent = "Exchanging code for token...";
        tokenResponsePre.textContent = "// waiting...";

        try {
          const res = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code: code }),
          });
          const txt = await res.text();
          try {
            const json = JSON.parse(txt);
            tokenResponsePre.textContent = JSON.stringify(json, null, 2);
          } catch (e) {
            tokenResponsePre.textContent = txt;
          }
          authText.textContent = "Exchange completed — see token response.";
        } catch (err) {
          authText.textContent = "Exchange failed: " + err.message;
          tokenResponsePre.textContent = err.stack || err.message;
        }
      }

      btnExchange.addEventListener("click", () => {
        const code = qs("code");
        if (!code) {
          alert("No code in URL to exchange.");
          return;
        }
        exchangeCode(code);
      });

      // show saved last auth url/state if present
      savedStateInput.value = localStorage.getItem("tiktok_oauth_state") || "";
      lastAuthUrlInput.value =
        localStorage.getItem("tiktok_last_auth_url") || "";
    </script>
  </body>
</html>
